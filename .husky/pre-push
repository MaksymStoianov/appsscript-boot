#!/bin/bash

# Переходим в корневой каталог репозитория
cd "$(git rev-parse --show-toplevel)" || exit 1

# Проверка на наличие node_modules
echo "[plugin husky:pre-push]: Checking for node_modules..."
if [ ! -d "node_modules" ]; then
  echo " ✗ Error: Missing node_modules. Please run 'npm install' first."
  exit 1
fi
echo " ✓ Done."
echo "" # Добавляем пустую строку для лучшей читаемости

# 1. Запуск аудита безопасности
echo "[plugin husky:pre-push]: Running npm audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo " ✗ Error: npm audit failed."
  exit 1
fi
echo " ✓ Done."
echo ""

# 2. Проверка типов TypeScript без компиляции
echo "[plugin husky:pre-push]: Running tsc..."
tsc --noEmit
if [ $? -ne 0 ]; then
  echo " ✗ Error: TypeScript check failed."
  exit 1
fi
echo " ✓ Done."
echo ""

# 3. Линтинг и форматирование
echo "[plugin husky:pre-push]: Running lint..."
npm run lint
if [ $? -ne 0 ]; then
  echo " ✗ Error: Linting failed."
  exit 1
fi
echo " ✓ Done."
echo ""

echo "[plugin husky:pre-push]: Running format..."
npm run format
if [ $? -ne 0 ]; then
  echo " ✗ Error: Formatting failed."
  exit 1
fi
echo " ✓ Done."
echo ""

echo "[plugin husky:pre-push]: Running test..."
npm run test
if [ $? -ne 0 ]; then
  echo " ✗ Error: Test failed."
  exit 1
fi
echo " ✓ Done."
echo ""

echo "[plugin husky:pre-push]: All checks passed successfully."
exit 0